<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GGE ‚Üí Excel ‚Äî –æ—Ñ–ª–∞–π–Ω‚Äë–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä</title>
  <meta name="description" content="–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä .gge ‚Üí .xlsx –∏–ª–∏ .xls. –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è GitHub Pages." />
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      /* –ù–µ–∂–Ω–∞—è –ø–∞—Å—Ç–µ–ª—å–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
      --bg: #f6f7fb;
      --card: #ffffff;
      --ink: #2a2f3a;
      --muted: #737b8c;
      --primary: #7aa7ff;   /* –≤–∞—Å–∏–ª—å–∫–æ–≤—ã–π */
      --primary-weak: #e8f0ff;
      --accent: #ffa3c0;    /* —Ä–æ–∑–æ–≤—ã–π –ø–∞—Å—Ç–µ–ª—å */
      --ok: #72d1b1;        /* –º—è—Ç–Ω—ã–π */
      --warn: #ffd88a;      /* –∫—Ä–µ–º–æ–≤—ã–π */
      --err: #ff98a4;       /* –∫–æ—Ä–∞–ª–ª –ø–∞—Å—Ç–µ–ª—å */
      --ring: 0 0 0 4px rgba(122,167,255,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color: var(--ink);
      background:
        radial-gradient(900px 600px at 10% -10%, #ffeef6 0%, transparent 60%),
        radial-gradient(900px 600px at 110% 10%, #eaf2ff 0%, transparent 60%),
        var(--bg);
      display: grid; place-items: start center; padding: 36px 16px;
    }
    .app { width: 100%; max-width: 980px; }

    header { text-align: center; margin-bottom: 22px; }
    h1 { margin: 0; font-weight: 800; letter-spacing:.2px; font-size: clamp(22px, 3.5vw, 38px); }
    p.sub { margin: 8px 0 0; color: var(--muted); }

    .card {
      background: var(--card);
      border: 1px solid #eef0f6;
      border-radius: 18px;
      padding: 22px;
      box-shadow: 0 20px 60px rgba(35, 46, 73, .08);
    }

    .grid { display: grid; gap: 18px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.1fr .9fr; } }

    .dropzone {
      display: grid; place-items: center; text-align: center; gap: 14px;
      border: 2px dashed #d8def0; border-radius: 16px; padding: 28px; transition: .2s ease;
      background: linear-gradient(180deg, #fbfcff 0, #f8fbff 100%);
    }
    .dropzone.dragover { border-color: var(--primary); background: var(--primary-weak); }
    .dropzone input[type=file] { display: none; }

    .btn {
      display: inline-flex; align-items: center; gap: 10px;
      padding: 11px 16px; border-radius: 12px; border: 1px solid #d7def1;
      background: linear-gradient(180deg, #fff, #f7f9ff);
      color: var(--ink); font-weight: 600; cursor: pointer; text-decoration: none;
      box-shadow: 0 6px 20px rgba(122,167,255,.15);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }

    .format {
      display:flex; gap:10px; align-items:center; justify-content:center; margin-top:8px;
      color: var(--muted); font-size: 14px;
    }
    .format label { display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; cursor:pointer; }
    .format input { accent-color: var(--primary); }

    .hints { display: grid; gap: 8px; margin-top: 10px; color: var(--muted); font-size: 14px; }

    .status { margin-top: 16px; display: grid; gap: 10px; }
    .pill { display: inline-block; padding: 5px 10px; border-radius: 999px; font-size: 12px; border: 1px solid #e6e9f4; background: #f7f9ff; }
    .ok { background: linear-gradient(180deg, #e9fbf5, #dff7ef); border-color:#d3f2e7; color:#0f3d2f; }
    .warn { background: linear-gradient(180deg, #fff8e6, #fff2d2); border-color:#ffe6aa; color:#5a4200; }
    .err { background: linear-gradient(180deg, #ffe9ec, #ffe1e5); border-color:#ffd0d6; color:#5a1e24; }

    footer { margin-top: 20px; color: var(--muted); font-size: 13px; text-align: center; }
    code.inline { background: #f1f5ff; padding: 2px 6px; border-radius: 6px; }
    a { color: #5a8cff; text-underline-offset: 3px; }

    .list { line-height:1.7; padding-left: 18px; }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <h1>GGE ‚Üí Excel</h1>
      <p class="sub">–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è <b>.gge</b> –≤ <b>.xlsx</b> –∏–ª–∏ <b>.xls</b> –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</p>
    </header>

    <section class="card grid">
      <div>
        <div id="drop" class="dropzone" tabindex="0" role="button" aria-label="–ó–æ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤">
          <div style="font-size: 18px; font-weight: 700;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª <span class="pill">*.gge</span></div>
          <div style="color:var(--muted)">–∏–ª–∏</div>
          <label class="btn" for="file">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª‚Ä¶</label>
          <input id="file" type="file" accept=".gge,.json,.txt,.csv,.tsv" />

          <div class="format" aria-label="–§–æ—Ä–º–∞—Ç –≤—ã–≥—Ä—É–∑–∫–∏">
            <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫:</span>
            <label><input type="radio" name="fmt" value="xlsx" checked> <b>.xlsx</b> (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π)</label>
            <label><input type="radio" name="fmt" value="xls"> <b>.xls</b> (Excel 97‚Äì2003)</label>
          </div>

          <div class="hints">
            <div>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è <b>—Ç–µ–∫—Å—Ç–æ–≤—ã–µ</b> .gge: JSON, CSV/TSV –∏ –ø–æ—Ö–æ–∂–∏–µ. –í–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É.</div>
            <div>–ï—Å–ª–∏ —ç—Ç–æ <b>–±–∏–Ω–∞—Ä–Ω—ã–π</b> .gge, –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ‚Äî –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É.</div>
          </div>
        </div>

        <div class="status" id="status"></div>
      </div>

      <div>
        <h3 style="margin:0 0 6px 0">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è</h3>
        <ol class="list">
          <li>–§–∞–π–ª —á–∏—Ç–∞–µ—Ç—Å—è <b>–ª–æ–∫–∞–ª—å–Ω–æ</b> ‚Äî –æ–Ω –Ω–µ –ø–æ–∫–∏–¥–∞–µ—Ç –≤–∞—à –±—Ä–∞—É–∑–µ—Ä.</li>
          <li>–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ <b>JSON</b>.
            <ul>
              <li>–ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –ª–∏—Å—Ç <i>data</i> –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ª–∏—Å—Ç—ã –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è.</li>
              <li>–ï—Å–ª–∏ —ç—Ç–æ —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ ‚Äî –¥–µ–ª–∞–µ–º –æ–¥–∏–Ω –ª–∏—Å—Ç <i>data</i>.</li>
            </ul>
          </li>
          <li>–ï—Å–ª–∏ –Ω–µ JSON ‚Äî –ø—Ä–æ–±—É–µ–º –∫–∞–∫ <b>CSV/TSV</b> —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è.</li>
          <li>–ï—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –≤ –ª–∏—Å—Ç <i>raw</i>.</li>
          <li>–ü–æ—Ö–æ–∂–µ –Ω–∞ –±–∏–Ω–∞—Ä–Ω—ã–π .gge? –ü–æ–∫–∞–∂–µ–º –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.</li>
        </ol>
        <p style="margin:10px 0 0">–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –∫–∞–∫ <code class="inline">.xlsx</code> –∏–ª–∏ <code class="inline">.xls</code> ‚Äî —Å–æ–≥–ª–∞—Å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É.</p>
      </div>
    </section>

    <footer>
    </footer>
  </main>

<script>
  const $ = (s) => document.querySelector(s);
  const drop = $('#drop');
  const fileInput = $('#file');
  const statusBox = $('#status');

  const getFormat = () => (document.querySelector('input[name="fmt"]:checked')?.value || 'xlsx');

  function setStatus(html, kind = '') {
    const cls = kind ? `pill ${kind}` : 'pill';
    statusBox.innerHTML = `<span class="${cls}">${kind === 'ok' ? '–ì–æ—Ç–æ–≤–æ' : kind === 'warn' ? '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ' : kind === 'err' ? '–û—à–∏–±–∫–∞' : '–°—Ç–∞—Ç—É—Å'}</span>`
      + `<div>${html}</div>`;
  }

  function downloadExcel(wb, filename, fmt) {
    const safe = (filename || 'converted').replace(/\.[^.]+$/, '') || 'converted';
    if (fmt === 'xls') {
      XLSX.writeFile(wb, safe + '.xls', { bookType: 'biff8' });
    } else {
      XLSX.writeFile(wb, safe + '.xlsx', { compression: true });
    }
  }

  function flattenObject(obj, prefix = '', out = {}) {
    for (const [k, v] of Object.entries(obj)) {
      const key = prefix ? `${prefix}.${k}` : k;
      if (v && typeof v === 'object' && !Array.isArray(v)) {
        flattenObject(v, key, out);
      } else if (Array.isArray(v)) {
        const allObjects = v.every(x => x && typeof x === 'object' && !Array.isArray(x));
        out[key] = allObjects ? `[${v.length} objects]` : v.join(', ');
      } else {
        out[key] = v;
      }
    }
    return out;
  }

  function isProbablyBinary(str) {
    const nul = (str.match(/ /g) || []).length;
    const weird = (str.match(/[ --]/g) || []).length;
    return nul > 0 || weird > Math.max(24, str.length * 0.05);
  }

  function detectDelimiter(text) {
    const lines = text.split(/
?
/).slice(0, 20);
    const cand = [',',';','	','|'];
    let best = { sep: null, score: -1 };
    for (const sep of cand) {
      let counts = lines.map(l => (l.split(sep).length - 1));
      const avg = counts.reduce((a,b)=>a+b,0) / (counts.length || 1);
      const varc = counts.reduce((a,b)=>a + Math.pow(b-avg,2), 0) / (counts.length || 1);
      const score = avg - varc * 0.1;
      if (avg >= 1.5 && score > best.score) best = { sep, score };
    }
    return best.sep;
  }

  function parseAsJSON(text) {
    try {
      const obj = JSON.parse(text);
      const wb = XLSX.utils.book_new();
      if (Array.isArray(obj)) {
        if (obj.length && typeof obj[0] === 'object') {
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(obj), 'data');
        } else {
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["value"], ...obj.map(v=>[v])]), 'data');
        }
      } else if (obj && typeof obj === 'object') {
        const flat = [flattenObject(obj)];
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(flat), 'data');
        for (const [k,v] of Object.entries(obj)) {
          if (Array.isArray(v) && v.length && typeof v[0] === 'object') {
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(v), (k||'list').substring(0,31));
          }
        }
      } else {
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["value"],[String(obj)]]), 'data');
      }
      return wb;
    } catch(e) { return null; }
  }

  function parseAsCSV(text) {
    const sep = detectDelimiter(text);
    if (!sep) return null;
    const rows = text.split(/
?
/).map(line => line.split(sep));
    if (!rows.length || rows.every(r => r.length <= 1)) return null;
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), 'data');
    return wb;
  }

  async function handleFile(file) {
    setStatus(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–∞–π–ª: <b>${file.name}</b>‚Ä¶`);
    const fmt = getFormat();

    const text = await file.text();
    if (!isProbablyBinary(text)) {
      const wbJSON = parseAsJSON(text);
      if (wbJSON) {
        setStatus(`–û–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ <b>JSON</b>. –ì–æ—Ç–æ–≤–ª—é Excel‚Ä¶`, 'ok');
        downloadExcel(wbJSON, file.name, fmt);
        return;
      }
      const wbCSV = parseAsCSV(text);
      if (wbCSV) {
        setStatus(`–û–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ <b>CSV/TSV</b>. –ì–æ—Ç–æ–≤–ª—é Excel‚Ä¶`, 'ok');
        downloadExcel(wbCSV, file.name, fmt);
        return;
      }
      const wb = XLSX.utils.book_new();
      const lines = text.split(/
?
/);
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["raw_text"], ...lines.map(l=>[l])]), 'raw');
      setStatus(`–≠—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞. –°–æ—Ö—Ä–∞–Ω–∏–ª —Å—Ç—Ä–æ–∫–∏ –≤ –ª–∏—Å—Ç <i>raw</i>.`, 'warn');
      downloadExcel(wb, file.name, fmt);
      return;
    }

    setStatus(
      `–ü–æ—Ö–æ–∂–µ, —ç—Ç–æ <b>–±–∏–Ω–∞—Ä–Ω—ã–π .gge</b> (–æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–ø–µ—á–∞—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã).
`+
      `–î–ª—è —Ç–∞–∫–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –ø–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—É, –∫–æ—Ç–æ—Ä–∞—è –µ–≥–æ —Å–æ–∑–¥–∞–ª–∞.`,
      'warn'
    );
  }

  fileInput.addEventListener('change', () => {
    const f = fileInput.files && fileInput.files[0];
    if (f) handleFile(f);
  });

  ;['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); }));
  ;['dragleave','drop'].forEach(evt => drop.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); }));
  drop.addEventListener('drop', e => { const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f) handleFile(f); });
  drop.addEventListener('click', () => fileInput.click());
  drop.addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') fileInput.click(); });
</script>
</body>
</html>
